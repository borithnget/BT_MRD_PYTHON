{% extends 'base.html' %}
{% load i18n %}
{% get_current_language as CURRENT_LANGUAGE %}

{% block title %}{% trans 'menu_my_task' %}{% endblock %}

{% block first_breadcrums %}
{% if watersupplytype_id == 0 %}
<li class="breadcrumb-item active" aria-current="page">{% trans 'menu_water_supply' %}</li>
{% else %}
<li class="breadcrumb-item active" aria-current="page">{% trans 'menu_my_task' %}</li>
{% endif %}
{% endblock %}

{% block content %}
<input type="hidden" id="is_data_entry" value="{{ request.session.user.is_data_entry }}" />
<input type="hidden" id="current_lang" value="{{ CURRENT_LANGUAGE }}" />
<div class="row">
    <div class="col-md-12">
        {% if request.session.user.is_data_entry %}
        <nav>
            <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">
                    {% if request.session.user.is_data_entry %}
                        {% trans 'label_draft' %}
                    {% else %}
                        {% trans 'label_pending' %}
                    {% endif %}
                </a>
                <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">{% trans 'label_request_history' %}</a>             
            </div>
        </nav>
        {% endif %}
        <div class="tab-content" id="nav-tabContent">
            {% if request.session.user.is_data_entry %}
            <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                <div class="table-responsive" >
                    <table class="table table-bordered" cellspacing="0" id="table_draft" style="width:100% !important;">
                        <thead>
                            <tr>
                                <th>{% trans 'province' %}</th>
                                <th>{% trans 'district' %}</th>
                                <th>{% trans 'commune' %}</th>
                                <th>{% trans 'village' %}</th>
                                <th>{% trans 'created_at' %}</th>
                                <th>{% trans 'water_supply_type' %}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            <div class="tab-pane fade {% if request.session.user.is_provincial_department_head %} show active {% endif %}" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
                <div class="table-responsive">
                    <table class='table table-bordered' id="table_1" style="width:100% !important;">
                        <thead>
                            <tr>
                                <th>{% trans 'water_supply_code' %}</th>
                                <th>{% trans 'province' %}</th>
                                <th>{% trans 'district' %}</th>
                                <th>{% trans 'commune' %}</th>
                                <th>{% trans 'village' %}</th>
                                <th>{% trans 'created_at' %}</th>
                                <th>{% trans 'water_supply_type' %}</th>
                                <th>{% trans 'ws_status' %}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script type="text/javascript">
    $(function(){
        $(document).ready(function () {
            var is_data_entry = $("#is_data_entry").val();

            //alert(is_data_entry);

            $('#table_draft').DataTable({
                ajax: {
                    url: "{% url 'ajax_get_myrequest_draft_list' %}",
                    type: "get"
                },
                columns: [
                    { render : function (data, type, row) {
                            {% if CURRENT_LANGUAGE == 'en' %}
                                return row.province_id.name_en;
                            {% else %}
                                return row.province_id.name_kh;
                            {% endif %}
                        },
                    },
                    { render : function (data, type, row) {
                            {% if CURRENT_LANGUAGE == 'en' %}
                                return row.district_id.name_en;
                            {% else %}
                                return row.district_id.name_kh;
                            {% endif %}
                        },
                    },
                    { render : function (data, type, row) {
                            {% if CURRENT_LANGUAGE == 'en' %}
                                return row.commune_id.name_en;
                            {% else %}
                                return row.commune_id.name_kh;
                            {% endif %}
                        },
                    },
                    { render : function (data, type, row) {
                            {% if CURRENT_LANGUAGE == 'en' %}
                                return row.village_id.name_en;
                            {% else %}
                                return row.village_id.name_kh;
                            {% endif %}
                        },
                    },
                    { data : "created_at"},
                    { render : function (data, type, row) {
                            {% if CURRENT_LANGUAGE == 'en' %}
                                return row.water_supply_type_id.name_en;
                            {% else %}
                                return row.water_supply_type_id.name_kh;
                            {% endif %}
                        },
                    },
                    { render : function (data, type, row) {
                        //console.log(row);
                        var current_lang=$('#current_lang').val();
                        var btn ='<div class="btn-group" role="group" aria-label="Basic example">'+
                            '<a href="/'+current_lang+'/watersupply/detail/'+row.id+'" class="btn btn-outline-primary btn-sm"><i class="fa fa-eye"></i> {% trans "btn_view_detail" %}</a>'+
                            '<a href="'+current_lang+'/watersupply/edit/'+row.id+'" class="btn btn-outline-primary btn-sm" ><i class="fa fa-edit"></i> {% trans "btn_edit" %}</a>'+
                            //'<a href="" class="btn btn-outline-primary btn-sm" ><i class="fa fa-trash"></i> </a>'+
                            '</div>';
                            return btn;
                            // return '<a href="/watersupply/detail/'+row.id+'" class="btn btn-sm btn-outline-primary">{% trans "btn_view_detail" %}</a>';
                        },
                    },
                ],
                columnDefs: [
                    {
                        targets: 6,
                        className: 'dt-body-center'
                    }
                ]
            });
            
            //Request History
            if(is_data_entry=='True'){
                $('#table_1').DataTable({
                    ajax: {
                        url: "{% url 'ajax_get_myrequest_history_list' %}",
                        type: "get"
                    },
                    columns: [
                    { render : function (data, type, row) {
                                return row.water_supply_code;
                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.province_id.name_en;
                                {% else %}
                                    return row.province_id.name_kh;
                                {% endif %}
                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.district_id.name_en;
                                {% else %}
                                    return row.district_id.name_kh;
                                {% endif %}

                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.commune_id.name_en;
                                {% else %}
                                    return row.commune_id.name_kh;
                                {% endif %}
                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.village_id.name_en;
                                {% else %}
                                    return row.village_id.name_kh;
                                {% endif %}

                            },
                        },
                        { data : "created_at"},
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.water_supply_type_id.name_en;
                                {% else %}
                                    return row.water_supply_type_id.name_kh;
                                {% endif %}

                            },
                        },
                        { render : function (data, type, row) {
                                return '<span class="badge badge-warning">'+row.main_status.status_name_kh+'</span>';
                            },
                        },
                        { render : function (data, type, row) {
                                 //console.log(row);
                                var current_lang = $('#current_lang').val();
                                return '<a href="/'+current_lang+'/watersupply/detail/'+row.id+'" class="btn btn-sm btn-outline-primary">{% trans "btn_view_detail" %}</a>';
                            },
                        },
                    ]
                });
            }
            else{
                $('#table_1').DataTable({
                    ajax: {
                        url: "{% url 'ajax_get_phd_requested_history' %}",
                        type: "get"
                    },
                    columns: [
                    { render : function (data, type, row) {

                                return row.watersupply_id.water_supply_code;
                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.watersupply_id.province_id.name_en;
                                {% else %}
                                    return row.watersupply_id.province_id.name_kh;
                                {% endif %}

                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.watersupply_id.district_id.name_en;
                                {% else %}
                                    return row.watersupply_id.district_id.name_kh;
                                {% endif %}

                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.watersupply_id.commune_id.name_en;
                                {% else %}
                                    return row.watersupply_id.commune_id.name_kh;
                                {% endif %}

                                //return '';
                            },
                        },
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.watersupply_id.village_id.name_en;
                                {% else %}
                                    return row.watersupply_id.village_id.name_kh;
                                {% endif %}

                                //return '';
                            },
                        },
                        { data : "created_at"},
                        { render : function (data, type, row) {
                                {% if CURRENT_LANGUAGE == 'en' %}
                                    return row.watersupply_id.water_supply_type_id.name_en;
                                {% else %}
                                    return row.watersupply_id.water_supply_type_id.name_kh;
                                {% endif %}

                                //return '';
                            },
                        },
                        { render : function (data, type, row) {
                                return '<span class="badge badge-warning">'+row.watersupply_id.main_status.status_name_kh+'</span>';
                                //return '';
                            },
                        },
                        { render : function (data, type, row) {
                                console.log(row);
                                btn ='<div class="btn-group" role="group" aria-label="Basic example">'+
                            '<a href="/watersupply/detail/'+row.watersupply_id.id+'" class="btn btn-outline-primary btn-sm"><i class="fa fa-eye"></i> {% trans "btn_view_detail" %}</a>';
                            
                            //'<a href="" class="btn btn-outline-primary btn-sm" ><i class="fa fa-trash"></i> </a>'+
                            
                            if(row.watersupply_id.main_status.id == 13){
                                btn=btn + '<a href="/watersupply/edit/'+row.watersupply_id.id+'" class="btn btn-outline-primary btn-sm" ><i class="fa fa-edit"></i> {% trans "btn_edit" %}</a>';
                            }
                            btn=btn+'</div>';
                                return btn;
                            },
                        },
                    ]
                });
            }
        
        });
    });

</script>
{% endblock %}