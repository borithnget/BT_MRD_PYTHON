{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{% trans 'menu_report_water_supply_coverage' %}{% endblock %}
{% block first_breadcrums %}
<li class="breadcrumb-item">{% trans 'menu_report' %}</li>
<li class="breadcrumb-item active" aria-current="page">{% trans 'menu_report_water_supply_coverage_map' %}</li>
{% endblock %}
{% block style %}
    <style>
#map {
        height: 500px !important;
        width: 100% !important;
        /* position: inherit !important; */
        overflow: hidden !important;
    }

    .gm-style-iw-d div{
        color: black !important;
    }
    </style>
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="card" style="width: 100%;">
        <div class="card-header"><h4>{% trans 'menu_report_water_supply_coverage_map' %}</h4></div>
        <div class="card-body">
            <form method="post" id="myForm">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group row">
                            <label class="control-label col-md-4">{% trans 'CoverageBy' %}</label>
                                <div class="col-md-8">
                                    <select class="form-control" id="coverage_by">
                                        <option value="0">{% trans 'select_option' %}</option>
                                        <option value="1">{% trans 'Country' %}</option>
                                        <option value="2">{% trans 'province' %}</option>
                                        {% comment %} <option value="3">{% trans 'district' %}</option>
                                        <option value="4">{% trans 'commune' %}</option>
                                        <option value="5">{% trans 'village' %}</option> {% endcomment %}
                                    </select>
                                </div>
                        </div>
            
                        <div class="form-group row">
                            <label class="control-label col-md-4">{% trans 'water_supply_type' %}</label>
                            <div class="col-md-8">
                                <select class="form-control" id="md_ws_type">
                                    <option value="0">{% trans 'all' %}</option>
                                    {% for watersupplytype in watersupplytypelist %}
                                        <option value="{{ watersupplytype.id }}">{{ watersupplytype.name_kh }}</option>
                                        
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
            
                        <div class="form-group row" id="province_panel">
                            <label class='col-md-4 control-label'>{% trans 'province' %} <strong class="text-danger">*</strong></label>
                            <div class="col-md-8">
                                <select class='form-control select2' id="province" name="province"​​ style="width: 100% !important;">
                                    {% for province in provinces %}
                                        <option value="{{ province.id }}" data-population="{{ province.total_population }}">{{ province.name_kh }}
                                    {% endfor %}
                                </select>
                            </div>             
                        </div>
                        <div class="form-group row" id="district_panel">
                            <label class='col-md-4 control-label'>{% trans 'district' %} <strong class="text-danger">*</strong></label>
                            <div class="col-md-8">
                                <select class='form-control select2' id="district" name="district" style="width: 100% !important;">
                                    
                                </select>
                            </div>
                        </div>     
                        <div class="form-group row" id="commune_panel">
                            <label class='col-md-4 control-label'>{% trans 'commune' %} <strong class="text-danger">*</strong></label>
                            <div class="col-md-8">
                                <select class='form-control select2' id="commune" name="commune" style="width: 100% !important;">
                                    
                                </select>
                            </div>                            
                        </div>
                        <div class="form-group row" id="village_panel">
                            <label class='col-md-4 control-label'>{% trans 'village' %} <strong class="text-danger">*</strong></label>
                            <div class="col-md-8">
                                <select class='form-control select2' id="village" name="village" style="width: 100% !important;">
                                    
                                </select>
                            </div>
                        </div>
                        <div class="form-group row ">
                            <div class="col-md-4"></div>
                            <div class="col-md-8">
                                
                                <button type="button" class="btn btn-sm btn-primary"​ id="btn_filter"><i class="fa fa-filter"></i>{% trans 'btn_filter' %}</button>
                            </div>                     
                          </div>
                    </div>
                    <div class="col-md-8">
                        <div class="pageholder">
                            <div class="linkholder">
                                <div id="map"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script src="https://maps.googleapis.com/maps/api/js?key={{key}}&callback=initMap&v=weekly&libraries=places" defer></script>
<script type="text/javascript">
    let map;
    let markers = [];
    let map_border_latlng="";

    $(function(){

        $('.select2').select2();
        window.initMap = initMap;

        enablegeoinformation($('#coverage_by').val());

        {% comment %} $('#province').change(function(e){
            var province_id = $(this).val();
            inititalDistrictDropdownList(province_id);

        });   
            
        $('#district').change(function(e){
            initialCommuneDropdownList(); 
        });

        $('#commune').change(function(e){
            intialVillageDropdownList();
        }); {% endcomment %}

        $('#coverage_by').change(function(e){
            var id = $(this).val();
            enablegeoinformation(id);
        });

        $('#btn_filter').click(function(){
            var id=$('#coverage_by').val();
            var ws_type = $('#md_ws_type').val();

            if(id==2){
                //Province Coverage
                var province=$('#province').select2('data');
                var total_population = $("#province option:selected").attr('data-population');
                console.log(total_population);

                $.ajax({
                    type: 'GET',
                    url: "{% url 'ajax_get_beneficiarytotalpeople' %}",
                    data: {
                        "ws_type" : ws_type,
                        "province_id":province[0].id,
                        
                    },
                    success: function (response) {
                        
                        if(!response["valid"]){
                            console.log(response);
                            var data=response.data;
                            beneficiary_total_people = data.beneficiary_total_people==null?0: parseFloat(data.beneficiary_total_people);
                            var beneficiary_percentage =total_population==0?0: (beneficiary_total_people*100)/total_population;

                            var province = response.province;
                            var province_center_latlng=province.coordinate_center.split(',');

                            var latlng={lat: parseFloat(province_center_latlng[0]), lng: parseFloat(province_center_latlng[1])};

                            map = new google.maps.Map(document.getElementById('map'), {
                                center: latlng,
                                zoom: 9.5,
                                mapTypeId: 'hybrid'
                            });

                            deleteMarkers();
                            placeMarker(latlng, parseFloat(beneficiary_percentage).toFixed(2));

                            new google.maps.Polygon({
                                paths: buildCoordinatesArrayFromString(province.coordinate_border),
                                strokeColor: '#0000FF',
                                strokeOpacity: 0.9,
                                strokeWeight: 1,
                                fillColor: '#FF0000',
                                fillOpacity: 0.5
                            }).setMap(map);


                            // $('#table_coverage').append("<thead>"+
                            //     "<tr>"+
                            //         "<th>{% trans 'no' %}</th>"+
                            //         "<th>{% trans 'province' %}</th>"+
                            //         "<th>{% trans 'water_supply_type' %}</th>"+
                            //         "<th>{% trans 'beneficiary_total_people' %}</th>"+
                            //         "<th>{% trans 'total_population' %}</th>"+
                            //         "<th>{% trans 'percentage' %}</th>"+
                            //     "</tr>"+
                            // "</thead><tbody>"+
                            //     "<tr>"+
                            //         "<td class='text-center'>1</td>"+
                            //         "<td>"+province[0].text+"</td>"+
                            //         "<td>"+ws_type_text+"</td>"+
                            //         "<td class='text-center'>"+beneficiary_total_people+"</td>"+
                            //         "<td class='text-center'>"+total_population+"</td>"+
                            //         "<td class='text-center'>"+ parseFloat(beneficiary_percentage).toFixed(2)+"</td>"+
                            //         "</tr>"+
                            //     "</tbody>"
                            //     ); 
                            //alert("You cannot create a friend with same nick name");   
                                                
                        }
                    },
                    error: function (response) {
                        console.log(response)
                    }
                });
            }
            

        });

    });
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: 12.7,
                    lng: 104.883333
                },
                zoom: 7,
                mapTypeId: 'hybrid'
            });
    }
    function inititalDistrictDropdownList(province_id){
            
            $('#district').empty().append('<option value="0">{% trans "select_option" %} </option>');
            $('#commune').empty();
            $('#village').empty();

            $.ajax({
                type: 'GET',
                url: "{% url 'ajax_get_district' %}",
                data: {"province_id":province_id },
                success: function (response) {
                    
                    if(!response["valid"]){
                        console.log(response);
                        $.each(response.district,function(ind,dis){
                            $('#district').append("<option value='"+dis.id+"'>"+dis.name_kh+"</option>");
                        });
                        //alert("You cannot create a friend with same nick name");   
                                            
                    }
                },
                error: function (response) {
                    console.log(response)
                }
            });

    }

        function initialCommuneDropdownList(){
            var district_id=$('#district').val();
            $('#commune').empty().append('<option value="0">{% trans "select_option" %}</option>');
            $('#village').empty();
            $.ajax({
                type: 'GET',
                url: "{% url 'ajax_get_commune_list' %}",
                data: {"district_id":district_id },
                success: function (response) {
                    
                    if(!response["valid"]){
                        console.log(response);
                        $.each(response.communes,function(ind,commune){
                            $('#commune').append("<option value='"+commune.id+"'>"+commune.name_kh+"</option>");


                        });
                        //alert("You cannot create a friend with same nick name");                        
                    }
                },
                error: function (response) {
                    console.log(response)
                }
            });
        }

        function intialVillageDropdownList(){
            var commune_id=$('#commune').val();
            $('#village').empty().append('<option value="0">{% trans "select_option" %}</option>');

            $.ajax({
                type: 'GET',
                url: "{% url 'ajax_get_village_list' %}",
                data: {"commune_id":commune_id },
                success: function (response) {
                    
                    if(!response["valid"]){
                        console.log(response);
                        $.each(response.villages,function(ind,village){
                            $('#village').append("<option value='"+village.id+"'>"+village.name_kh+"</option>");
                        });
                        //alert("You cannot create a friend with same nick name");                        
                    }
                },
                error: function (response) {
                    console.log(response)
                }
            });
        }

        function enablegeoinformation(coverage_by){
            $('#province_panel').hide();
            $('#district_panel').hide();
            $('#commune_panel').hide();
            $('#village_panel').hide();
            coverage_by=parseFloat(coverage_by);

            if(coverage_by==2){
                $('#province_panel').show();
            }else if (coverage_by==3){
                $('#province_panel').show();
                $('#district_panel').show();
            }else if(coverage_by==4){
                $('#province_panel').show();
                $('#district_panel').show();
                $('#commune_panel').show();
            }else if(coverage_by==5){
                $('#province_panel').show();
                $('#district_panel').show();
                $('#commune_panel').show();
                $('#village_panel').show();
            }

        }
        
        function placeMarker(location,marker_title) {
            var marker = new google.maps.Marker({
                position: location, 
                map: map,
                title : marker_title + " %"
            });
            markers.push(marker);
        }
        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function hideMarkers() {
            setMapOnAll(null);
        }

        // Shows any markers currently in the array.
        function showMarkers() {
            setMapOnAll(map);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            hideMarkers();
            markers = [];
        }

        function buildCoordinatesArrayFromString(MultiGeometryCoordinates){
            var finalData = [];
            var grouped = MultiGeometryCoordinates.split(" ");
    
            grouped.forEach(function(item, i){
                let a = item.trim().split(',');
    
                finalData.push({
                    lng: parseFloat(a[0]),
                    lat: parseFloat(a[1])
                });
            });
    
    
            return finalData;
        }

    </script>
{% endblock %}